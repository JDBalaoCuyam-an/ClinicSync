<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Patient</title>
    <script type="module" src="../../firebaseconfig.js"></script>
    <link rel="stylesheet" href="../../assets/styles/ViewPatient.css" />
    <link rel="stylesheet" href="../../assets/styles/globalCSS.css" />
  </head>
  <body>
    <!-- NavBar -->
    <header class="navbar">
      <div class="menu-icon" onclick="toggleSidebar()">&#9776;</div>
      <h1>ClinicSync</h1>
    </header>

    <!-- SideBar -->
    <div id="sidebar" class="sidebar">
      <div class="current-user">
        <div class="user-info">
          <div class="user-icon">
            <img src="../../assets/images/ClinicSyncLogo.png" alt="User Icon" />
          </div>
          <div class="user-name">Dr. John Doe</div>
          <div class="user-role"><b>Doctor</b></div>
        </div>
        <div class="menu-icon" onclick="toggleSidebar()">&#9776;</div>
      </div>
      <ul>
        <li><a href="DoctorNurseDashboard.html">Home</a></li>
        <li class="active">
          <a href="MedicalRecords.html">Medical Records</a>
        </li>
        <li><a href="Schedules.html">Schedules</a></li>
        <li><a href="MedicineInventory.html">Medicine Inventory</a></li>
        <li><a href="ClinicInventory.html">Clinic Inventory</a></li>
      </ul>
      <form>
        <button type="submit" id="logout-button">Log Out</button>
      </form>
    </div>
    <div id="overlay" class="overlay"></div>

    <!-- Appointment Modal -->
    <!-- Appointment Modal -->
    <div id="appointment-modal" class="modal" style="display: none">
      <div class="appointment-modal-content">
        <h2>New Appointment</h2>
        <form id="appointment-form">
          <label>
            Doctor:
            <input type="text" id="appt-doctor" required />
          </label>
          <label>
            Date:
            <input type="date" id="appt-date" required />
          </label>
          <label>
            Time:
            <input type="time" id="appt-time" required />
          </label>
          <label>
            Purpose / Details:
            <input type="text" id="appt-purpose" required />
          </label>
          <div class="modal-actions">
            <button type="submit">Save Appointment</button>
            <button type="button" id="close-appointment">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <div style="display: flex; justify-content: space-between">
      <button
        id="back-to-lists"
        onclick="window.location.href='MedicalRecords.html'"
      >
        Back
      </button>
      <button id="make-appointment">Make Appointment</button>
    </div>

    <div class="view-patient-container">
      <div class="left-container">
        <div class="patient-contacts">
          <div style="display: flex; justify-content: space-between">
            <h2>(Patient Name)</h2>
            <button id="edit-contacts" class="edit-btn">Edit</button>
          </div>
          <h3>Contact Details</h3>
          <input
            type="text"
            id="phone-number"
            name="phone-number"
            placeholder="Phone Number"
            disabled
          />
          <input
            type="text"
            id="email-address"
            name="email-address"
            placeholder="Email Address"
            disabled
          />
          <input
            type="text"
            id="home-address"
            name="home-address"
            placeholder="Home Address"
            disabled
          />
          <input
            type="text"
            id="guardian-name"
            name="guardian-name"
            placeholder="Guardian's Name"
            disabled
          />
          <input
            type="text"
            id="guardian-phone"
            name="guardian-phone"
            placeholder="Guardian's Phone Number"
            disabled
          />
        </div>
        <!--  -->
        <div class="patient-documents">
          <h3>Documents :</h3>
          <button class="upload-btn" id="upload-btn">Upload Files</button>
          <input type="file" id="file-input" style="display: none" />
          <ul class="documents-list" id="documents-list">
            
            
          </ul>
        </div>
      </div>
      <!-- Patient Records -->
      <div class="right-container">
        <div class="patient-records">
          <!-- Tabs -->
          <input type="radio" id="patient-info" name="tab" checked />
          <label class="radio-tabs" for="patient-info">Patient Info</label>

          <input type="radio" id="medical-history" name="tab" />
          <label class="radio-tabs" for="medical-history"
            >Medical History</label
          >

          <input type="radio" id="medical-consultation" name="tab" />
          <label class="radio-tabs" for="medical-consultation"
            >Medical Consultation Records</label
          >

          <input type="radio" id="physical-examination" name="tab" />
          <label class="radio-tabs" for="physical-examination"
            >Physical Examination</label
          >

          <!-- Tab Contents -->
          <div class="tab-content patient-info-content">
            <div class="header-row">
              <h2>Patient Information</h2>
              <button class="edit-btn">‚úèÔ∏è Edit</button>
            </div>

            <div class="info-grid">
              <label
                >Last Name : <input id="lastName" type="text" disabled
              /></label>
              <label
                >First Name : <input id="firstName" type="text" disabled
              /></label>
              <label
                >Middle Name : <input id="middleName" type="text" disabled
              /></label>
              <label
                >Ext. Name : <input id="extName" type="text" disabled
              /></label>
              <label>Gender : <input id="gender" type="text" disabled /></label>

              <label
                >Birthdate : <input id="birthdate" type="date" disabled
              /></label>
              <label>Age : <input id="age" type="number" disabled /></label>
              <label
                >Civil Status : <input id="civilStatus" type="text" disabled
              /></label>
              <label
                >Nationality : <input id="nationality" type="text" disabled
              /></label>
              <label
                >Religion : <input id="religion" type="text" disabled
              /></label>

              <label
                >School ID : <input id="schoolId" type="text" disabled
              /></label>
              <label>Role : <input id="role" type="text" disabled /></label>
              <label
                >Department : <input id="department" type="text" disabled
              /></label>
              <label>Course : <input id="course" type="text" disabled /></label>
              <label>Year : <input id="year" type="number" disabled /></label>
            </div>

            <br />
            <hr />
            <br />

            <h3>Parent‚Äôs Information</h3>
            <div class="info-grid" id="parent-info-grid">
              <label
                >Father‚Äôs Name : <input id="fatherName" type="text" disabled
              /></label>
              <label
                >Father's Age : <input id="fatherAge" type="number" disabled
              /></label>
              <label
                >Father's Occupation :
                <input id="fatherOccupation" type="text" disabled
              /></label>
              <label
                >Father's Health Status :
                <input id="fatherHealth" type="text" disabled
              /></label>

              <label
                >Mother‚Äôs Name : <input id="motherName" type="text" disabled
              /></label>
              <label
                >Mother's Age : <input id="motherAge" type="number" disabled
              /></label>
              <label
                >Mother's Occupation :
                <input id="motherOccupation" type="text" disabled
              /></label>
              <label
                >Mother's Health Status :
                <input id="motherHealth" type="text" disabled
              /></label>
            </div>
          </div>

          <div class="tab-content medical-history-content">
            <div class="header-row">
              <h2>Medical History :</h2>
              <button class="edit-btn">‚úèÔ∏è Edit</button>
            </div>

            <div class="history-grid">
              <div class="history-card">
                <h3>Past Medical History</h3>
                <textarea disabled>---</textarea>
              </div>

              <div class="history-card">
                <h3>Family History</h3>
                <textarea disabled>---</textarea>
              </div>

              <div class="history-card">
                <h3>Past Surgical History</h3>
                <textarea disabled></textarea>
              </div>
            </div>
            <!-- end of history-grid -->

            <!-- Additional Medical Info Section -->
            <div class="additional-info">
              <div class="history-card">
                <h3>Nutritional Supplements / Vitamins / Other Medications</h3>
                <textarea
                  disabled
                  placeholder="Enter details here..."
                ></textarea>
              </div>

              <div class="history-card">
                <h3>Allergies</h3>
                <textarea
                  disabled
                  placeholder="List allergies here..."
                ></textarea>
              </div>

              <!-- üîπ Immunization Section -->
              <div class="history-card immunization-card">
                <h3>Immunization</h3>
                <div class="immunization-form">
                  <div class="immunization-row">
                    <label>BCG:</label
                    ><input name="bcg" type="text" disabled />
                    <label>DPT:</label
                    ><input name="dpt" type="text" disabled />
                    <label>OPV:</label><input name="opv" type="text" disabled />
                  </div>
                  <div class="immunization-row">
                    <label>HEP. B:</label
                    ><input name="hepb" type="text" disabled />
                    <label>MMR:</label
                    ><input name="mmr" type="text" disabled />
                    <label>MEASLES:</label
                    ><input name="measles" type="text" disabled />
                  </div>
                  <div class="immunization-row">
                    <label>OTHERS:</label
                    ><input
                      type="text"
                      name="others"
                      disabled
                      style="flex: 1"
                    />
                  </div>
                </div>
              </div>

              <!-- üîπ OB-GYNE History Section -->
              <div class="history-card obgyne-card">
                <h3>OB-GYNE History (Female Only)</h3>
                <div class="obgyne-form">
                  <div class="ob-row">
                    <label>Age of First Menstrual Period:</label>
                    <input type="text" name="menarcheAge" disabled />
                  </div>

                  <div class="ob-row">
                    <label>Duration/Days:</label>
                    <input type="text" name="durationDays" disabled />
                    <label>Napkin/s per Day:</label>
                    <input type="text" name="napkinsPerDay" disabled />
                    <label>Interval:</label>
                    <input type="text" name="interval" disabled />
                  </div>

                  <div class="ob-row dysmenorrhea-row">
                    <label>Dysmenorrhea:</label>
                    <div class="radio-group">
                      <label
                        ><input
                          type="radio"
                          name="dysmenorrhea"
                          value="No"
                          disabled
                        />
                        No</label
                      >
                      <label
                        ><input
                          type="radio"
                          name="dysmenorrhea"
                          value="Sometimes"
                          disabled
                        />
                        Sometimes</label
                      >
                      <label
                        ><input
                          type="radio"
                          name="dysmenorrhea"
                          value="Moderate"
                          disabled
                        />
                        Moderate</label
                      >
                      <label
                        ><input
                          type="radio"
                          name="dysmenorrhea"
                          value="Severe"
                          disabled
                        />
                        Severe</label
                      >
                    </div>
                  </div>

                  <div class="ob-row">
                    <label>Last Menstrual:</label>
                    <input type="date" name="lastMenstrual" disabled />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tab-content medical-consultation-content">
            <h2>Medical Consultation Records :</h2>

            <button onclick="addConsultationRecordOverlay()" class="new-btn">
              + New
            </button>

            <table>
              <thead>
                <tr>
                  <th>Cons. Dr.</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Chief Complaint</th>
                  <th>Diagnosis</th>
                  <th>Meds.</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Dr. John Doe</td>
                  <td>10/07/2025</td>
                  <td>10:00 AM</td>
                  <td>Head Ache</td>
                  <td>-</td>
                  <td>-</td>
                </tr>
                <tr>
                  <td>Dr. John Doe</td>
                  <td>04/07/2025</td>
                  <td>10:00 AM</td>
                  <td>Head Ache</td>
                  <td>Tension Head Ache</td>
                  <td>Paracetamol</td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- New Consultation Record -->
          <div id="add-consultation-record">
            <h2>New Consultation Record</h2>

            <form id="consultation-form">
              <label
                >Consulting Doctor:<input
                  type="text"
                  id="consult-doctor"
                  required
              /></label>
              <label
                >Date:<input type="date" id="consult-date" required
              /></label>
              <label
                >Time:<input type="time" id="consult-time" required
              /></label>
              <label
                >Chief Complaint:<input
                  type="text"
                  id="consult-complaint"
                  required
              /></label>
              <label
                >Diagnosis:<input type="text" id="consult-diagnosis"
              /></label>
              <label>Medications:<input type="text" id="consult-meds" /></label>

              <h4>Vital Signs</h4>
              <div class="vitals-grid">
                <label
                  >BP:<input type="text" id="vital-bp" placeholder="120/80"
                /></label>
                <label
                  >T (¬∞C):<input type="text" id="vital-temp" placeholder="36.5"
                /></label>
                <label
                  >SpO‚ÇÇ (%):<input type="text" id="vital-spo2" placeholder="98"
                /></label>
                <label
                  >PR (bpm):<input type="text" id="vital-pr" placeholder="75"
                /></label>
                <label>LMP:<input type="date" id="vital-lmp" /></label>
              </div>
              <label>Notes:<input type="text" id="consult-notes" /></label>

              <button type="submit" class="save-btn">Save</button>
              <button onclick="closeButtonOverlay()">Cancel</button>
            </form>
          </div>
          <div id="consultation-overview" class="consultation-modal">
            <div class="modal-content">
              <h2>Consultation Overview</h2>
              <div class="overview-details">
                <p><strong>Doctor:</strong> <span id="ovr-doctor"></span></p>
                <p><strong>Date:</strong> <span id="ovr-date"></span></p>
                <p><strong>Time:</strong> <span id="ovr-time"></span></p>
                <p>
                  <strong>Chief Complaint:</strong>
                  <span id="ovr-complaint"></span>
                </p>
                <p>
                  <strong>Diagnosis:</strong> <span id="ovr-diagnosis"></span>
                </p>
                <p><strong>Medications:</strong> <span id="ovr-meds"></span></p>
                <h4>Vital Signs</h4>
                <p><strong>BP:</strong> <span id="ovr-bp"></span></p>
                <p><strong>T (¬∞C):</strong> <span id="ovr-temp"></span></p>
                <p><strong>SpO‚ÇÇ:</strong> <span id="ovr-spo2"></span></p>
                <p><strong>PR (bpm):</strong> <span id="ovr-pr"></span></p>
                <p><strong>LMP:</strong> <span id="ovr-lmp"></span></p>
                <p><strong>Notes:</strong> <span id="ovr-notes"></span></p>
              </div>
              <button onclick="closeOverview()">Close</button>
            </div>
          </div>
          <div class="tab-content physical-examination-content">
            <h2>Physical Examination :</h2>

            <button onclick="addPhysicalExamOverlay()" class="new-btn">
              + New
            </button>

            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>BP</th>
                  <th>PR</th>
                  <th>Weight (kg)</th>
                  <th>Height (cm)</th>
                  <th>BMI</th>
                  <th>Findings</th>
                </tr>
              </thead>
              <tbody id="physical-exam-list"></tbody>
            </table>

            <div id="add-physical-exam">
              <h2>Physical Examination</h2>

              <p>
                <em><strong>TO BE FILLED OUT BY CLINIC PERSONNEL</strong></em>
              </p>
              <p><em>PHYSICAL EXAMINATION</em></p>

              <form id="physical-exam-form">
                <div class="vitals">
                  <label
                    >Date: <input type="date" id="exam-date" required
                  /></label>
                  <label
                    >BP: <input type="text" id="exam-bp" placeholder="120/80"
                  /></label>
                  <label
                    >PR: <input type="text" id="exam-pr" placeholder="75"
                  /></label>
                  <label
                    >Weight (kg): <input type="number" id="exam-weight"
                  /></label>
                  <label
                    >Height (cm): <input type="number" id="exam-height"
                  /></label>
                  <label
                    >BMI: <input type="number" id="exam-bmi" step="0.1"
                  /></label>
                  <label
                    >Visual Acuity (OS): <input type="text" id="exam-visual-os"
                  /></label>
                  <label>OD: <input type="text" id="exam-visual-od" /></label>
                  <label
                    >With Glasses: <input type="checkbox" id="exam-glasses"
                  /></label>
                </div>

                <div class="exam-section">
                  <div class="left-col">
                    <label>HEENT: <input type="text" id="exam-heent" /></label>
                    <label>TEETH: <input type="text" id="exam-teeth" /></label>
                    <label>NECK: <input type="text" id="exam-neck" /></label>
                    <label>CHEST: <input type="text" id="exam-chest" /></label>
                    <label>LUNGS: <input type="text" id="exam-lungs" /></label>
                    <label>HEART: <input type="text" id="exam-heart" /></label>
                    <label
                      >BREAST: <input type="text" id="exam-breast"
                    /></label>
                    <label>SKIN: <input type="text" id="exam-skin" /></label>
                    <label
                      >ABDOMEN: <input type="text" id="exam-abdomen"
                    /></label>
                  </div>

                  <div class="right-col">
                    <label
                      >BACK/FLANKS: <input type="text" id="exam-back"
                    /></label>
                    <label
                      >ANUS/RECTUM: <input type="text" id="exam-anus"
                    /></label>
                    <label
                      >GENITALIA: <input type="text" id="exam-genitalia"
                    /></label>
                    <label
                      >EXTREMITIES: <input type="text" id="exam-extremities"
                    /></label>
                    <label
                      >CLEANLINESS (Nails, Hair, Ears):
                      <input type="text" id="exam-cleanliness"
                    /></label>
                    <label
                      >POSTURE: <input type="text" id="exam-posture"
                    /></label>
                    <label
                      >NUTRITION: <input type="text" id="exam-nutrition"
                    /></label>
                    <label
                      >DEFORMITY: <input type="text" id="exam-deformity"
                    /></label>
                    <label
                      >OTHERS: <input type="text" id="exam-others"
                    /></label>
                  </div>
                </div>

                <h4>Laboratory and Ancillary Procedure</h4>
                <label
                  >Present: <input type="text" id="exam-lab-present"
                /></label>
                <label
                  >Recommendations:
                  <input type="text" id="exam-recommendations"
                /></label>

                <div class="form-buttons">
                  <button type="submit" class="save-btn">Save</button>
                  <button type="button" onclick="closeButtonOverlay()">
                    Cancel
                  </button>
                </div>
              </form>
            </div>
            <!-- üîπ PHYSICAL EXAM OVERVIEW MODAL -->
            <div id="exam-overview-modal">
              <div class="overview-content">
                <h2>Physical Examination Overview</h2>
                <div id="overview-details"></div>

                <button class="close-btn" onclick="closeExamOverview()">
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script src="../../script.js"></script>
  <script type="module">
    /* -----------------------------------------------
     üîπ FIREBASE IMPORTS & INITIAL SETUP
  ----------------------------------------------- */
    import { db } from "../../firebaseconfig.js";
    import {
      doc,
      getDoc,
      updateDoc,
      collection,
      addDoc,
      getDocs,
      serverTimestamp,
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("id");
    let isEditingContacts = false;

    /* -----------------------------------------------
     üîπ LOAD PATIENT DATA
  ----------------------------------------------- */
    async function loadPatient() {
      if (!patientId) return;

      try {
        const patientRef = doc(db, "patients", patientId);
        const patientSnap = await getDoc(patientRef);

        if (!patientSnap.exists()) {
          alert("Patient not found!");
          return;
        }

        const data = patientSnap.data();

        // üßæ Header Name
        document.querySelector(".patient-contacts h2").textContent = `${
          data.lastName + "," || ""
        } ${data.firstName || ""}`.trim();

        // üß© Contact Details
        document.getElementById("phone-number").value = data.contact || "";
        document.getElementById("email-address").value = data.email || "";
        document.getElementById("home-address").value = data.address || "";
        document.getElementById("guardian-name").value =
          data.guardianName || "";
        document.getElementById("guardian-phone").value =
          data.guardianPhone || "";

        // üß© Basic Info
        const infoFields = {
          lastName: data.lastName,
          firstName: data.firstName,
          middleName: data.middleName || "",
          extName: data.extName || "",
          gender: data.gender,
          birthdate: data.birthdate,
          age: data.age,
          civilStatus: data.civilStatus || "",
          nationality: data.nationality || "",
          religion: data.religion || "",
          schoolId: data.schoolId,
          role: data.role,
          department: data.department || "",
          course: data.course || "",
          year: data.year || "",
        };
        const infoInputs = document.querySelectorAll(
          ".patient-info-content .info-grid input"
        );
        Object.values(infoFields).forEach((val, i) => {
          if (infoInputs[i]) infoInputs[i].value = val;
        });

        // üß© Parent Info
        const parentFields = {
          fatherName: data.fatherName || "",
          fatherAge: data.fatherAge || "",
          fatherOccupation: data.fatherOccupation || "",
          fatherHealth: data.fatherHealth || "",
          motherName: data.motherName || "",
          motherAge: data.motherAge || "",
          motherOccupation: data.motherOccupation || "",
          motherHealth: data.motherHealth || "",
        };
        const parentInputs = document.querySelectorAll(
          "#parent-info-grid input"
        );
        Object.values(parentFields).forEach((val, i) => {
          if (parentInputs[i]) parentInputs[i].value = val;
        });

        // üß© Medical History + Additional Info
        const medFields = {
          pastMedicalHistory: data.pastMedicalHistory || "",
          familyHistory: data.familyHistory || "",
          pastSurgicalHistory: data.pastSurgicalHistory || "",
          supplements: data.supplements || "",
          allergies: data.allergies || "",
        };

        // set textareas (first 5)
        const medTextareas = document.querySelectorAll(
          ".medical-history-content textarea"
        );
        Object.values(medFields).forEach((val, i) => {
          if (medTextareas[i]) medTextareas[i].value = val;
        });

        // set immunization fields
        const immunizationFields = [
          "bcg",
          "dpt",
          "opv",
          "hepb",
          "mmr",
          "measles",
          "others",
        ];
        immunizationFields.forEach((key) => {
          const input = document.querySelector(
            `.immunization-form input[name='${key}']`
          );
          if (input) input.value = data[key] || "";
        });

        // set OB-GYNE fields
        const obgyneFields = [
          "menarcheAge",
          "durationDays",
          "napkinsPerDay",
          "interval",
          "lastMenstrual",
        ];
        obgyneFields.forEach((key) => {
          const input = document.querySelector(
            `.obgyne-form input[name='${key}']`
          );
          if (input) input.value = data[key] || "";
        });

        // set Dysmenorrhea radio
        if (data.dysmenorrhea) {
          const radio = document.querySelector(
            `.obgyne-form input[type='radio'][value='${data.dysmenorrhea}']`
          );
          if (radio) radio.checked = true;
        }
      } catch (err) {
        console.error("Error fetching patient:", err);
      }
    }

    /* -----------------------------------------------
     üîπ EDIT/SAVE CONTACT DETAILS
  ----------------------------------------------- */
    document
      .getElementById("edit-contacts")
      .addEventListener("click", async () => {
        const inputs = document.querySelectorAll(".patient-contacts input");

        if (!isEditingContacts) {
          // Enable editing
          inputs.forEach((inp) => inp.removeAttribute("disabled"));
          document.getElementById("edit-contacts").textContent = "üíæ Save";
          isEditingContacts = true;
        } else {
          // Save updated contact info
          const updatedData = {
            contact: document.getElementById("phone-number").value,
            email: document.getElementById("email-address").value,
            address: document.getElementById("home-address").value,
            guardianName: document.getElementById("guardian-name").value,
            guardianPhone: document.getElementById("guardian-phone").value,
          };

          try {
            await updateDoc(doc(db, "patients", patientId), updatedData);
            alert("Contact details updated!");
            inputs.forEach((inp) => inp.setAttribute("disabled", "true"));
            document.getElementById("edit-contacts").textContent = "‚úèÔ∏è Edit";
            isEditingContacts = false;
          } catch (err) {
            console.error("Error updating contact details:", err);
            alert("Failed to update contact details.");
          }
        }
      });

    /* -----------------------------------------------
     üîπ EDIT/SAVE MEDICAL HISTORY
  ----------------------------------------------- */
    const editHistoryBtn = document.querySelector(
      ".medical-history-content .edit-btn"
    );
    editHistoryBtn.addEventListener("click", async () => {
      const editableFields = document.querySelectorAll(
        ".medical-history-content textarea, .medical-history-content input"
      );

      if (editHistoryBtn.textContent.includes("‚úèÔ∏è")) {
        editableFields.forEach((el) => el.removeAttribute("disabled"));
        editHistoryBtn.textContent = "üíæ Save";
      } else {
        const [
          pastMedical,
          familyHistory,
          pastSurgical,
          supplements,
          allergies,
        ] = Array.from(
          document.querySelectorAll(".medical-history-content textarea")
        ).map((ta) => ta.value.trim());

        // get immunization values
        const immunizationData = {};
        document
          .querySelectorAll(".immunization-form input")
          .forEach(
            (input) => (immunizationData[input.name] = input.value.trim())
          );

        // get OB-GYNE values
        const obgyneData = {};
        document
          .querySelectorAll(
            ".obgyne-form input[type='text'], .obgyne-form input[type='date']"
          )
          .forEach((input) => (obgyneData[input.name] = input.value.trim()));

        const dysmenorrhea =
          document.querySelector(".obgyne-form input[type='radio']:checked")
            ?.value || "";

        try {
          await updateDoc(doc(db, "patients", patientId), {
            pastMedicalHistory: pastMedical,
            familyHistory,
            pastSurgicalHistory: pastSurgical,
            supplements,
            allergies,
            ...immunizationData,
            ...obgyneData,
            dysmenorrhea,
          });

          alert("Medical History updated!");
          editableFields.forEach((el) => el.setAttribute("disabled", "true"));
          editHistoryBtn.textContent = "‚úèÔ∏è Edit";
        } catch (err) {
          console.error("Error updating medical history:", err);
          alert("Failed to update medical history.");
        }
      }
    });

    /* -----------------------------------------------
     üîπ EDIT/SAVE PATIENT INFORMATION
  ----------------------------------------------- */
    const editPatientInfoBtn = document.querySelector(
      ".patient-info-content .edit-btn"
    );
    editPatientInfoBtn.addEventListener("click", async () => {
      const infoInputs = document.querySelectorAll(
        ".patient-info-content .info-grid input"
      );

      if (editPatientInfoBtn.textContent.includes("‚úèÔ∏è")) {
        infoInputs.forEach((input) => input.removeAttribute("disabled"));
        editPatientInfoBtn.textContent = "üíæ Save";
      } else {
        const updatedData = {
          lastName: lastName.value,
          firstName: firstName.value,
          middleName: middleName.value,
          extName: extName.value,
          gender: gender.value,
          birthdate: birthdate.value,
          age: Number(age.value),
          civilStatus: civilStatus.value,
          nationality: nationality.value,
          religion: religion.value,
          schoolId: schoolId.value,
          role: role.value,
          department: department.value,
          course: course.value,
          year: Number(year.value),

          fatherName: fatherName.value,
          fatherAge: Number(fatherAge.value),
          fatherOccupation: fatherOccupation.value,
          fatherHealth: fatherHealth.value,
          motherName: motherName.value,
          motherAge: Number(motherAge.value),
          motherOccupation: motherOccupation.value,
          motherHealth: motherHealth.value,
        };

        try {
          await updateDoc(doc(db, "patients", patientId), updatedData);
          alert("Patient information updated!");
          infoInputs.forEach((input) => input.setAttribute("disabled", "true"));
          editPatientInfoBtn.textContent = "‚úèÔ∏è Edit";
        } catch (err) {
          console.error("Error updating patient information:", err);
          alert("Failed to update patient information.");
        }
      }
    });

    /* -----------------------------------------------
     üîπ CONSULTATION FORM SUBMIT
  ----------------------------------------------- */
    document
      .getElementById("consultation-form")
      .addEventListener("submit", async (e) => {
        e.preventDefault();

        const consultData = {
          consultingDoctor: document.getElementById("consult-doctor").value,
          date: document.getElementById("consult-date").value,
          time: document.getElementById("consult-time").value,
          complaint: document.getElementById("consult-complaint").value,
          diagnosis: document.getElementById("consult-diagnosis").value,
          meds: document.getElementById("consult-meds").value,
          notes: document.getElementById("consult-notes").value,
          vitals: {
            bp: document.getElementById("vital-bp").value,
            temp: document.getElementById("vital-temp").value,
            spo2: document.getElementById("vital-spo2").value,
            pr: document.getElementById("vital-pr").value,
            lmp: document.getElementById("vital-lmp").value,
          },
          createdAt: new Date(),
        };

        try {
          const consultRef = collection(
            db,
            "patients",
            patientId,
            "consultations"
          );
          await addDoc(consultRef, consultData);
          alert("Consultation Record Saved!");
          loadConsultations();
          closeButtonOverlay();
        } catch (err) {
          console.error("Error adding consultation:", err);
          alert("Failed to save consultation record.");
        }
      });

    /* -----------------------------------------------
     üîπ LOAD CONSULTATION RECORDS
  ----------------------------------------------- */
    async function loadConsultations() {
      const tableBody = document.querySelector(
        ".medical-consultation-content tbody"
      );
      tableBody.innerHTML = "";

      try {
        const consultRef = collection(
          db,
          "patients",
          patientId,
          "consultations"
        );
        const snapshot = await getDocs(consultRef);

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${data.consultingDoctor}</td>
          <td>${data.date}</td>
          <td>${data.time}</td>
          <td>${data.complaint}</td>
          <td>${data.diagnosis || "-"}</td>
          <td>${data.meds || "-"}</td>
        `;
          tr.addEventListener("click", () => showConsultationDetails(data));
          tableBody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loading consultations:", err);
      }
    }

    /* -----------------------------------------------
     üîπ SHOW CONSULTATION DETAILS (MODAL)
  ----------------------------------------------- */
    window.showConsultationDetails = function (data) {
      document.getElementById("ovr-doctor").textContent = data.consultingDoctor;
      document.getElementById("ovr-date").textContent = data.date;
      document.getElementById("ovr-time").textContent = data.time;
      document.getElementById("ovr-complaint").textContent = data.complaint;
      document.getElementById("ovr-diagnosis").textContent =
        data.diagnosis || "-";
      document.getElementById("ovr-meds").textContent = data.meds || "-";
      document.getElementById("ovr-notes").textContent = data.notes || "-";

      // Vital Signs
      document.getElementById("ovr-bp").textContent = data.vitals.bp || "-";
      document.getElementById("ovr-temp").textContent = data.vitals.temp || "-";
      document.getElementById("ovr-spo2").textContent = data.vitals.spo2 || "-";
      document.getElementById("ovr-pr").textContent = data.vitals.pr || "-";
      document.getElementById("ovr-lmp").textContent = data.vitals.lmp || "-";

      document.getElementById("consultation-overview").classList.add("show");
    };

    window.closeOverview = function () {
      document.getElementById("consultation-overview").classList.remove("show");
    };
    /* -----------------------------------------------
 üîπ SAVE PHYSICAL EXAMINATION RECORD
----------------------------------------------- */
    document
      .getElementById("physical-exam-form")
      .addEventListener("submit", async (e) => {
        e.preventDefault();

        const physicalData = {
          date: document.getElementById("exam-date").value,
          bp: document.getElementById("exam-bp").value,
          pr: document.getElementById("exam-pr").value,
          weight: Number(document.getElementById("exam-weight").value),
          height: Number(document.getElementById("exam-height").value),
          bmi: Number(document.getElementById("exam-bmi").value),
          visualAcuity: {
            os: document.getElementById("exam-visual-os").value,
            od: document.getElementById("exam-visual-od").value,
            glasses: document.getElementById("exam-glasses").checked,
          },
          findings: {
            heent: document.getElementById("exam-heent").value,
            teeth: document.getElementById("exam-teeth").value,
            neck: document.getElementById("exam-neck").value,
            chest: document.getElementById("exam-chest").value,
            lungs: document.getElementById("exam-lungs").value,
            heart: document.getElementById("exam-heart").value,
            breast: document.getElementById("exam-breast").value,
            skin: document.getElementById("exam-skin").value,
            abdomen: document.getElementById("exam-abdomen").value,
            back: document.getElementById("exam-back").value,
            anus: document.getElementById("exam-anus").value,
            genitalia: document.getElementById("exam-genitalia").value,
            extremities: document.getElementById("exam-extremities").value,
            cleanliness: document.getElementById("exam-cleanliness").value,
            posture: document.getElementById("exam-posture").value,
            nutrition: document.getElementById("exam-nutrition").value,
            deformity: document.getElementById("exam-deformity").value,
            others: document.getElementById("exam-others").value,
          },
          labPresent: document.getElementById("exam-lab-present").value,
          recommendations: document.getElementById("exam-recommendations")
            .value,
          createdAt: new Date(),
        };

        try {
          const examRef = collection(
            db,
            "patients",
            patientId,
            "physicalExaminations"
          );
          await addDoc(examRef, physicalData);
          alert("Physical Examination Record Saved!");
          loadPhysicalExaminations();
          closeButtonOverlay();
          e.target.reset();
        } catch (err) {
          console.error("Error saving physical examination:", err);
          alert("Failed to save Physical Examination.");
        }
      });

    /* -----------------------------------------------
 üîπ LOAD PHYSICAL EXAMINATION RECORDS
----------------------------------------------- */
    async function loadPhysicalExaminations() {
      const tableBody = document.getElementById("physical-exam-list");
      tableBody.innerHTML = "";

      try {
        const examRef = collection(
          db,
          "patients",
          patientId,
          "physicalExaminations"
        );
        const snapshot = await getDocs(examRef);

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const tr = document.createElement("tr");

          tr.innerHTML = `
    <td>${data.date || "-"}</td>
    <td>${data.bp || "-"}</td>
    <td>${data.pr || "-"}</td>
    <td>${data.weight || "-"}</td>
    <td>${data.height || "-"}</td>
    <td>${data.bmi || "-"}</td>
    <td>${data.findings?.others || "Normal physical findings"}</td>
  `;

          // üëá Add click event to show overview
          tr.addEventListener("click", () => showExamOverview(data));
          tableBody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loading physical examinations:", err);
      }
    }
    // Overview Modal for Physical Exam
    window.showExamOverview = function (data) {
      const overviewDiv = document.getElementById("overview-details");

      overviewDiv.innerHTML = `
    <p><strong>Date:</strong> ${data.date || "-"}</p>
    <p><strong>BP:</strong> ${data.bp || "-"}</p>
    <p><strong>PR:</strong> ${data.pr || "-"}</p>
    <p><strong>Weight:</strong> ${data.weight || "-"} kg</p>
    <p><strong>Height:</strong> ${data.height || "-"} cm</p>
    <p><strong>BMI:</strong> ${data.bmi || "-"}</p>
    
    <h4>üëÅÔ∏è Visual Acuity</h4>
    <p><strong>OS:</strong> ${data.visualAcuity?.os || "-"}</p>
    <p><strong>OD:</strong> ${data.visualAcuity?.od || "-"}</p>
    <p><strong>Glasses:</strong> ${
      data.visualAcuity?.glasses ? "Yes" : "No"
    }</p>

    <h4>ü©∫ Physical Findings</h4>
    ${Object.entries(data.findings || {})
      .map(
        ([key, val]) =>
          `<p><strong>${key.toUpperCase()}:</strong> ${val || "-"}</p>`
      )
      .join("")}

    <h4>üß™ Laboratory & Recommendations</h4>
    <p><strong>Laboratory Procedure:</strong> ${data.labPresent || "-"}</p>
    <p><strong>Recommendations:</strong> ${data.recommendations || "-"}</p>
  `;

      document.getElementById("exam-overview-modal").style.display = "flex";
    };

    window.closeExamOverview = function () {
      document.getElementById("exam-overview-modal").style.display = "none";
    };

    // Schedule/Appointment
    const appointmentModal = document.getElementById("appointment-modal");
    const makeAppointmentBtn = document.getElementById("make-appointment");
    const closeAppointmentBtn = document.getElementById("close-appointment");
    const appointmentForm = document.getElementById("appointment-form");

    // üîπ Open Modal
    makeAppointmentBtn.addEventListener("click", () => {
      appointmentModal.style.display = "flex";
    });

    // üîπ Close Modal
    closeAppointmentBtn.addEventListener("click", () => {
      appointmentModal.style.display = "none";
    });

    // üîπ Save Appointment (with Full Name)
    appointmentForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const selectedDate = document.getElementById("appt-date").value;
      const time = document.getElementById("appt-time").value;
      const doctor = document.getElementById("appt-doctor").value.trim();
      const details = document.getElementById("appt-purpose").value.trim();

      if (!selectedDate || !time || !doctor || !details) {
        alert("Please fill out all fields.");
        return;
      }

      try {
        // üß† Fetch patient document to get full name
        const patientRef = doc(db, "patients", patientId);
        const patientSnap = await getDoc(patientRef);

        if (!patientSnap.exists()) {
          alert("Patient record not found!");
          return;
        }

        const patientData = patientSnap.data();
        const fullName = `${patientData.lastName || ""}, ${
          patientData.firstName || ""
        }`.trim();

        // üíæ Save appointment with full name as "person"
        await addDoc(collection(db, "schedules"), {
          date: selectedDate,
          time,
          person: fullName,
          doctor,
          details,
          status: "upcoming",
          createdAt: serverTimestamp(),
        });

        alert("‚úÖ Appointment Saved!");
        appointmentModal.style.display = "none";
        appointmentForm.reset();
      } catch (error) {
        console.error("Error adding appointment:", error);
        alert("‚ùå Failed to save appointment. Try again.");
      }
    });
    /* -----------------------------------------------
     üîπ INITIAL LOAD
  ----------------------------------------------- */
    loadPatient();
    await loadConsultations();
    await loadPhysicalExaminations();
  </script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = "https://oiskavcbaczvewywuana.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9pc2thdmNiYWN6dmV3eXd1YW5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjMxODIsImV4cCI6MjA3NjE5OTE4Mn0.ZsDy-ZGwy1ZE3wwydCOgxz5NsI2RyrmUXzDXq1oCegs";

    const supabaseClient = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    const uploadBtn = document.getElementById("upload-btn");
    const fileInput = document.getElementById("file-input");
    const documentsList = document.getElementById("documents-list");

    uploadBtn.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const fileName = `${Date.now()}_${file.name}`;

      // ‚úÖ Upload file to your "patient-documents" bucket
      const { data, error } = await supabaseClient.storage
        .from("patient-documents")
        .upload(fileName, file, {
          cacheControl: "3600",
          upsert: false,
        });

      if (error) {
        console.error("Upload failed:", error);
        alert("‚ùå Upload failed: " + error.message);
        return;
      }

      // ‚úÖ Get the public URL
      const { data: publicData } = supabaseClient.storage
        .from("patient-documents")
        .getPublicUrl(fileName);

      // ‚úÖ Add file to list
      const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
      const listItem = document.createElement("li");
      listItem.innerHTML = `<a href="${publicData.publicUrl}" target="_blank">${file.name}</a> (${fileSizeMB} MB)`;
      documentsList.appendChild(listItem);

      alert("‚úÖ Upload successful!");
    });

    // ‚úÖ Load all uploaded files
    async function loadDocuments() {
      const { data, error } = await supabaseClient.storage
        .from("patient-documents")
        .list("", { limit: 100 });

      if (error) {
        console.error("Error loading files:", error);
        return;
      }

      documentsList.innerHTML = "";
      for (const item of data) {
        const { data: publicData } = supabaseClient.storage
          .from("patient-documents")
          .getPublicUrl(item.name);

        const listItem = document.createElement("li");
        listItem.innerHTML = `<a href="${publicData.publicUrl}" target="_blank">${item.name}</a>`;
        documentsList.appendChild(listItem);
      }
    }

    loadDocuments();
  </script>
</html>
