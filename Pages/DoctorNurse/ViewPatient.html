<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Patient</title>
    <script type="module" src="../../firebaseconfig.js"></script>
    <link rel="stylesheet" href="ViewPatient.css" />
    <link rel="stylesheet" href="../../assets/styles/globalCSS.css" />
  </head>
  <body>
    <!-- NavBar -->
    <header class="navbar">
      <div class="menu-icon" onclick="toggleSidebar()">&#9776;</div>
      <h1>ClinicSync</h1>
    </header>

    <!-- SideBar -->
    <div id="sidebar" class="sidebar">
      <div class="current-user">
        <div class="user-info">
          <div class="user-icon">
            <img src="../../assets/images/ClinicSyncLogo.png" alt="User Icon" />
          </div>
          <div class="user-name">Dr. John Doe</div>
          <div class="user-role"><b>Doctor</b></div>
        </div>
        <div class="menu-icon" onclick="toggleSidebar()">&#9776;</div>
      </div>
      <ul>
        <li><a href="DoctorNurseDashboard.html">Home</a></li>
        <li class="active">
          <a href="MedicalRecords.html">Medical Records</a>
        </li>
        <li><a href="Schedules.html">Schedules</a></li>
        <li><a href="MedicineInventory.html">Medicine Inventory</a></li>
        <li><a href="ClinicInventory.html">Clinic Inventory</a></li>
      </ul>
      <form>
        <button type="submit" id="logout-button">Log Out</button>
      </form>
    </div>

    <div style="display: flex; justify-content: space-between">
      <button
        id="back-to-lists"
        onclick="window.location.href='MedicalRecords.html'"
      >
        Back
      </button>
      <button id="make-appointment">Make Appointment</button>
    </div>

    <div class="view-patient-container">
      <div class="left-container">
        <div class="patient-contacts">
          <div style="display: flex; justify-content: space-between">
            <h2>(Patient Name)</h2>
            <button id="edit-contacts" class="edit-btn">Edit</button>
          </div>
          <h3>Contact Details</h3>
          <input
            type="text"
            id="phone-number"
            name="phone-number"
            placeholder="Phone Number"
            disabled
          />
          <input
            type="text"
            id="email-address"
            name="email-address"
            placeholder="Email Address"
            disabled
          />
          <input
            type="text"
            id="home-address"
            name="home-address"
            placeholder="Home Address"
            disabled
          />
          <input
            type="text"
            id="guardian-name"
            name="guardian-name"   
            placeholder="Guardian's Name"
            disabled
          />
          <input
            type="text"
            id="guardian-phone"
            name="guardian-phone"
            placeholder="Guardian's Phone Number"
            disabled
          />
        </div>
        <div class="patient-documents">
          <h3>Documents :</h3>
          <button class="upload-btn">Upload Files</button>
          <ul class="documents-list">
            <li>Ovarian Scan, Nov 25 (2.7 MB)</li>
            <li>XYV Blood Test (0.7 MB)</li>
            <li>Blood Test XYZ (2.7 MB)</li>
          </ul>
        </div>
      </div>
      <!-- Patient Records -->
      <div class="right-container">
        <div class="patient-records">
          <!-- Tabs -->
          <input type="radio" id="patient-info" name="tab" checked />
          <label class="radio-tabs" for="patient-info">Patient Info</label>

          <input type="radio" id="medical-history" name="tab" />
          <label class="radio-tabs" for="medical-history"
            >Medical History</label
          >

          <input type="radio" id="medical-records" name="tab" />
          <label class="radio-tabs" for="medical-records"
            >Medical Records</label
          >

          <input type="radio" id="dental-records" name="tab" />
          <label class="radio-tabs" for="dental-records">Dental Records</label>

          <input type="radio" id="physical-examination" name="tab" />
          <label class="radio-tabs" for="physical-examination"
            >Physical Examination</label
          >

          <!-- Tab Contents -->
          <div class="tab-content patient-info-content">
            <div class="header-row">
              <h2>Patient Information</h2>
              <button class="edit-btn">‚úèÔ∏è Edit</button>
            </div>

            <div class="info-grid">
              <label
                >Last Name : <input id="lastName" type="text" disabled
              /></label>
              <label
                >First Name : <input id="firstName" type="text" disabled
              /></label>
              <label
                >Middle Name : <input id="middleName" type="text" disabled
              /></label>
              <label
                >Ext. Name : <input id="extName" type="text" disabled
              /></label>
              <label>Gender : <input id="gender" type="text" disabled /></label>

              <label
                >Birthdate : <input id="birthdate" type="date" disabled
              /></label>
              <label>Age : <input id="age" type="number" disabled /></label>
              <label
                >Civil Status : <input id="civilStatus" type="text" disabled
              /></label>
              <label
                >Nationality : <input id="nationality" type="text" disabled
              /></label>
              <label
                >Religion : <input id="religion" type="text" disabled
              /></label>

              <label
                >School ID : <input id="schoolId" type="text" disabled
              /></label>
              <label>Role : <input id="role" type="text" disabled /></label>
              <label
                >Department : <input id="department" type="text" disabled
              /></label>
              <label>Course : <input id="course" type="text" disabled /></label>
              <label>Year : <input id="year" type="number" disabled /></label>
            </div>

            <br />
            <hr />
            <br />

            <h3>Parent‚Äôs Information</h3>
            <div class="info-grid" id="parent-info-grid">
              <label
                >Father‚Äôs Name : <input id="fatherName" type="text" disabled
              /></label>
              <label
                >Father's Age : <input id="fatherAge" type="number" disabled
              /></label>
              <label
                >Father's Occupation :
                <input id="fatherOccupation" type="text" disabled
              /></label>
              <label
                >Father's Health Status :
                <input id="fatherHealth" type="text" disabled
              /></label>

              <label
                >Mother‚Äôs Name : <input id="motherName" type="text" disabled
              /></label>
              <label
                >Mother's Age : <input id="motherAge" type="number" disabled
              /></label>
              <label
                >Mother's Occupation :
                <input id="motherOccupation" type="text" disabled
              /></label>
              <label
                >Mother's Health Status :
                <input id="motherHealth" type="text" disabled
              /></label>
            </div>
          </div>

          <div class="tab-content medical-history-content">
            <div class="header-row">
              <h2>Medical History :</h2>
              <button class="edit-btn" onclick="toggleEdit(this)">
                ‚úèÔ∏è Edit
              </button>
            </div>

            <div class="history-grid">
              <div class="history-card">
                <h3>Past Medical History</h3>
                <textarea disabled>
Lorem ipsum dolor sit amet consectetur adipisicing elit. Quasi repellat laborum culpa numquam! Quisquam debitis at cum velit tenetur, eius inventore id quae vero, autem, ullam eum voluptatum provident sit?</textarea
                >
              </div>

              <div class="history-card">
                <h3>Family History</h3>
                <textarea disabled>
Lorem ipsum dolor sit amet consectetur adipisicing elit. Quasi repellat laborum culpa numquam! Quisquam debitis at cum velit tenetur, eius inventore id quae vero, autem, ullam eum voluptatum provident sit?</textarea
                >
              </div>

              <div class="history-card">
                <h3>Past Surgical History</h3>
                <textarea disabled></textarea>
              </div>
            </div>
          </div>

          <div class="tab-content medical-records-content">
            <h2>Medical Consultation Records :</h2>

            <button class="new-btn">+ New</button>

            <table>
              <thead>
                <tr>
                  <th></th>
                  <th>Cons. Dr.</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Chief Complaint</th>
                  <th>Diagnosis</th>
                  <th>Meds.</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>üìÑ</td>
                  <td>Dr. John Doe</td>
                  <td>10/07/2025</td>
                  <td>10:00 AM</td>
                  <td>Head Ache</td>
                  <td>-</td>
                  <td>-</td>
                </tr>
                <tr>
                  <td>üìÑ</td>
                  <td>Dr. John Doe</td>
                  <td>04/07/2025</td>
                  <td>10:00 AM</td>
                  <td>Head Ache</td>
                  <td>Tension Head Ache</td>
                  <td>Paracetamol</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="tab-content dental-records-content">
            <h3>Dental Records :</h3>
            <button class="new-btn">+ New</button>

            <table>
              <thead>
                <tr>
                  <th></th>
                  <th>Const. Dr.</th>
                  <th>Date</th>
                  <th>Tooth</th>
                  <th>Procedure</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>üìÑ</td>
                  <td>Dr. John Doe</td>
                  <td>04/09/2025</td>
                  <td>28</td>
                  <td>Extraction</td>
                  <td>Mild Bleeding</td>
                </tr>
                <tr>
                  <td>üìÑ</td>
                  <td>Dr. John Doe</td>
                  <td>04/08/2025</td>
                  <td>14</td>
                  <td>Composite Filling</td>
                  <td>Mo Surface</td>
                </tr>
                <tr>
                  <td>üìÑ</td>
                  <td>Dr. John Doe</td>
                  <td>04/07/2025</td>
                  <td>-</td>
                  <td>Oral Exam</td>
                  <td>-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="tab-content physical-examination-content">
          <h2>Physical Examination</h2>
          <p>Files, attachments, and lab results...</p>
        </div>
      </div>
    </div>
  </body>
  <script src="../../script.js"></script>
  <script type="module">
  import { db } from "../../firebaseconfig.js";
  import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  // Get ID from URL (?id=xxxx)
  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get("id");
  let isEditingContacts = false;

  // Load patient data
  async function loadPatient() {
    if (!patientId) {
      alert("No patient ID provided");
      return;
    }

    try {
      const patientRef = doc(db, "patients", patientId);
      const patientSnap = await getDoc(patientRef);

      if (patientSnap.exists()) {
        const data = patientSnap.data();

        // Set name header
        document.querySelector(".patient-contacts h2").textContent =
          `${data.lastName + "," || ""} ${data.firstName || ""}`.trim();

        // Fill contact details
        document.getElementById("phone-number").value = data.contact || "";
        document.getElementById("email-address").value = data.email || "";
        document.getElementById("home-address").value = data.address || "";
        document.getElementById("guardian-name").value = data.guardianName || "";
        document.getElementById("guardian-phone").value = data.guardianPhone || "";

        // Fill patient info (basic example)
        const infoFields = {
          lastName: data.lastName,
          firstName: data.firstName,
          middleName: data.middleName || "",
          extName: data.extName || "",
          gender: data.gender,
          birthdate: data.birthdate,
          age: data.age,
          civilStatus: data.civilStatus || "",
          nationality: data.nationality || "",
          religion: data.religion || "",
          schoolId: data.schoolId,
          role: data.role,
          department: data.department || "",
          course: data.course || "",
          year: data.year || "",
        };

        const infoInputs = document.querySelectorAll(".patient-info-content .info-grid input");
        Object.values(infoFields).forEach((val, i) => {
          if (infoInputs[i]) infoInputs[i].value = val;
        });

        
        // Fill parent info
const parentFields = {
  fatherName: data.fatherName || "",
  fatherAge: data.fatherAge || "",
  fatherOccupation: data.fatherOccupation || "",
  fatherHealth: data.fatherHealth || "",
  motherName: data.motherName || "",
  motherAge: data.motherAge || "",
  motherOccupation: data.motherOccupation || "",
  motherHealth: data.motherHealth || "",
};

const parentInputs = document.querySelectorAll("#parent-info-grid input");
Object.values(parentFields).forEach((val, i) => {
  if (parentInputs[i]) parentInputs[i].value = val;
});

      } else {
        alert("Patient not found!");
      }
    } catch (err) {
      console.error("Error fetching patient:", err);
    }
  }

  // Edit/Save toggle for Contact Details
  document.getElementById("edit-contacts").addEventListener("click", async () => {
    const inputs = document.querySelectorAll(".patient-contacts input");

    if (!isEditingContacts) {
      // Enable editing
      inputs.forEach((inp) => inp.removeAttribute("disabled"));
      document.getElementById("edit-contacts").textContent = "üíæ Save";
      isEditingContacts = true;
    } else {
      // Save updated data
      const updatedData = {
        contact: document.getElementById("phone-number").value,
        email: document.getElementById("email-address").value,
        address: document.getElementById("home-address").value,
        guardianName: document.getElementById("guardian-name").value,
        guardianPhone: document.getElementById("guardian-phone").value,
      };

      try {
        const patientRef = doc(db, "patients", patientId);
        await updateDoc(patientRef, updatedData);

        alert("Contact details updated!");

        // Disable editing again
        inputs.forEach((inp) => inp.setAttribute("disabled", "true"));
        document.getElementById("edit-contacts").textContent = "‚úèÔ∏è Edit";
        isEditingContacts = false;
      } catch (err) {
        console.error("Error updating contact details:", err);
        alert("Failed to update contact details.");
      }
    }
  });

  // Initial load
  loadPatient();
</script>


</html>
